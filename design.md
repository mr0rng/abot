# Описание архитектуры и дизайна бота

## Идея и сущности

Бот связывает людей, которым нужна помощь, с людьми, которые могут её предоставить, через категории помощи.
Категория помощи (Scenario) — это Место и Ресурс с описанием.
Пользователи (Users), которые могут помочь в этом месте с этой проблемой, связываются с категорией через
отдельную таблицу связи (UsersScenarios).
Другие пользователи могут создать запрос на помощь (Demand) по конкретной категории помощи.
У такого запроса есть участники (Participants) в разных ролях: запросивший, предоставляющий, модератор.
Пользователь, связанный с категорией помощи, может взять в работу новый запрос на эту помощь (метод demands.next).
Тогда пользователь добавляется к запросу с ролью «предоставляющий».
После этого запросивший и предоставляющий могут переписываться через бот, и бот будет передавать их сообщения
(Messages) друг другу. Если к запросу также подключился модератор, сообщения будут приходить и ей.
Предоставляющий может отказаться от запроса, после чего запрос может подхватить другой предоставляющий.
Запрашивающий может закрыть запрос, когда помощь оказана или больше не актуальна.

## Архитектура

Сервис управляется docker-compose
* База: postgres
* Хранилище сессий (для веб-фронта): redis
* Брокер сообщений: nats
* Микросервис api
* Микросервис telegram_bot
* Микросервис веб-фронт (в планах)

Телеграм бот слушает события от телеграма по вебсокету. Обрабатывая сообщения, он вызывает
апи телеграма для отправки сообщений, и микросервис апи для работы с сущностями сервиса.
Вызов микросервиса api идёт через брокера nats с ожиданием ответа сразу после запроса.
Микросервис api слушает nats для получения запросов, ходит в базу и хранилище сессий
и возвращает ответ.
Микросервис api отправляет уведомление в nats по отправке сообщения по поводу запроса
на помощь. Телеграм бот слушает nats для получения таких уведомлений и отправляет эти
сообщения в телеграм апи.

## Деплой

В папке example находится пример продакшн docker-compose файлов и переменных окружения
для запуска.
